<!doctype html>
<html lang="es">
  <head>
    <meta charset="utf-8" />
    <title>Mapa de reportes - Tulum Reporta</title>
    <meta name="viewport" content="width=device-width, initial-scale=1" />

    <!-- Leaflet CSS -->
    <link
      rel="stylesheet"
      href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
      integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY="
      crossorigin=""
    />

    <style>
      body {
        font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI",
          sans-serif;
        margin: 0;
        padding: 0;
        display: flex;
        flex-direction: column;
        height: 100vh;
      }
      header {
        padding: 0.75rem 1rem;
        background: #0f172a;
        color: #f9fafb;
        font-size: 0.9rem;
        display: flex;
        align-items: center;
        justify-content: space-between;
        gap: 0.75rem;
      }
      header .title {
        font-weight: 500;
        white-space: nowrap;
      }
      header .filter {
        flex: 1;
        display: flex;
        align-items: center;
        gap: 0.5rem;
        font-size: 0.8rem;
      }
      header label {
        white-space: nowrap;
      }
      header select {
        flex: 1;
        padding: 0.25rem 0.4rem;
        border-radius: 0.375rem;
        border: 1px solid #e5e7eb;
        font-size: 0.8rem;
        max-width: 260px;
      }
      main {
        flex: 1;
        display: flex;
        flex-direction: column;
      }
      #map {
        flex: 1;
      }
      .panel {
        padding: 0.5rem 1rem;
        border-top: 1px solid #e5e7eb;
        background: #f9fafb;
        font-size: 0.8rem;
        display: flex;
        justify-content: space-between;
        gap: 0.5rem;
      }
      .panel .note {
        color: #475569;
      }
      .panel .status {
        text-align: right;
        min-width: 120px;
      }
      .status.error {
        color: #b91c1c;
      }
      .status.ok {
        color: #15803d;
      }
    </style>
  </head>

  <body>
    <header>
      <div class="title">Tulum Reporta · Mapa de reportes</div>
      <div class="filter">
        <label for="zoneFilter">Zona:</label>
        <select id="zoneFilter">
          <option value="">Todas las zonas</option>
          <!-- Opciones dinámicas -->
        </select>
      </div>
    </header>

    <main>
      <div id="map"></div>

      <div class="panel">
        <div class="note">
          Filtra los reportes por zona (colonia, fraccionamiento, parque, región)
          sin mostrar los polígonos en el mapa.
        </div>
        <div id="status" class="status"></div>
      </div>
    </main>

    <!-- Leaflet JS -->
    <script
      src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
      integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo="
      crossorigin=""
    ></script>

    <!-- Turf.js para point-in-polygon -->
    <script src="https://cdn.jsdelivr.net/npm/@turf/turf@6/turf.min.js"></script>

    <script>
      (function () {
        const statusEl = document.getElementById("status");
        const zoneFilterEl = document.getElementById("zoneFilter");

        let map;
        let markers = []; // { marker, incident, zoneId }

        // Jerarquía de nivel mínimo (más específico primero)
        const ZONE_LEVEL_PRIORITY = ["colonia", "fraccionamiento", "parque", "region", null];

        function setStatus(msg, type = "") {
          statusEl.textContent = msg || "";
          statusEl.className = "status" + (type ? " " + type : "");
        }

        function getLevelPriority(nivel) {
          const idx = ZONE_LEVEL_PRIORITY.indexOf(nivel);
          return idx === -1 ? 999 : idx;
        }

        function initMap() {
          // Centro aproximado Tulum
          map = L.map("map", {
            center: [20.2119, -87.4654],
            zoom: 13,
            tap: true,
          });

          L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", {
            maxZoom: 19,
          }).addTo(map);
        }

        async function loadData() {
          try {
            setStatus("Cargando reportes y zonas...");

            const [incRes, zonasRes] = await Promise.all([
              fetch("/api/incidentes"),
              fetch("/data/zonas_tulum.geojson"),
            ]);

            if (!incRes.ok) {
              throw new Error("Error cargando incidentes.");
            }
            if (!zonasRes.ok) {
              throw new Error("Error cargando zonas.");
            }

            const incidents = await incRes.json();
            const zonasGeojson = await zonasRes.json();

            // Clasificar incidentes por zona (nivel mínimo de jerarquía)
            const zonas = zonasGeojson.features || [];

            const zoneIndex = {}; // id -> { id, nombre, nivel, count }
            const incidentWithZone = [];

            for (const incident of incidents) {
              if (
                typeof incident.lat !== "number" ||
                typeof incident.lon !== "number"
              ) {
                continue;
              }

              const point = turf.point([incident.lon, incident.lat]);
              let bestZone = null;
              let bestPriority = Infinity;

              for (const feat of zonas) {
                const props = feat.properties || {};
                const nivel = props.nivel || null;

                // Comprobar si el punto está dentro del polígono
                if (turf.booleanPointInPolygon(point, feat)) {
                  const prio = getLevelPriority(nivel);
                  if (prio < bestPriority) {
                    bestPriority = prio;
                    bestZone = feat;
                  }
                }
              }

              if (bestZone) {
                const props = bestZone.properties || {};
                const zoneId = props.id;
                const zoneNombre = props.nombre || props.id || "Zona sin nombre";
                const zoneNivel = props.nivel || null;

                incident.zoneId = zoneId;
                incident.zoneNombre = zoneNombre;
                incident.zoneNivel = zoneNivel;

                if (!zoneIndex[zoneId]) {
                  zoneIndex[zoneId] = {
                    id: zoneId,
                    nombre: zoneNombre,
                    nivel: zoneNivel,
                    count: 0,
                  };
                }
                zoneIndex[zoneId].count++;
              } else {
                // Incidente fuera de cualquier zona → sin zona asignada
                incident.zoneId = null;
              }

              incidentWithZone.push(incident);
            }

            renderMarkers(incidentWithZone);
            buildZoneFilter(zoneIndex);

            setStatus(
              `Reportes cargados: ${incidentWithZone.length}`,
              "ok"
            );
          } catch (err) {
            console.error(err);
            setStatus(err.message || "Error cargando datos.", "error");
          }
        }

        function renderMarkers(incidents) {
          const bounds = [];

          incidents.forEach((incident) => {
            if (
              typeof incident.lat !== "number" ||
              typeof incident.lon !== "number"
            ) {
              return;
            }

            const marker = L.marker([incident.lat, incident.lon]);

            const zonaLabel = incident.zoneNombre
              ? `${incident.zoneNombre} (${incident.zoneNivel || "sin nivel"})`
              : "Zona no asignada";

            const popupHtml = `
              <strong>${incident.categoria || "Reporte"}</strong><br/>
              ${incident.subcategoria || ""}<br/>
              <small>${zonaLabel}</small><br/>
              <p style="margin-top:4px; font-size:0.8rem;">
                ${incident.descripcion || ""}
              </p>
            `;

            marker.bindPopup(popupHtml);
            marker.addTo(map);

            markers.push({
              marker,
              incident,
              zoneId: incident.zoneId || null,
            });

            bounds.push([incident.lat, incident.lon]);
          });

          if (bounds.length > 0) {
            map.fitBounds(bounds, { padding: [20, 20] });
          }
        }

        function buildZoneFilter(zoneIndex) {
          // Limpiar opciones actuales (dejamos "Todas las zonas")
          while (zoneFilterEl.options.length > 1) {
            zoneFilterEl.remove(1);
          }

          const zonesArray = Object.values(zoneIndex);

          // Orden: por nivel (según prioridad) y luego por nombre
          zonesArray.sort((a, b) => {
            const pa = getLevelPriority(a.nivel);
            const pb = getLevelPriority(b.nivel);
            if (pa !== pb) return pa - pb;
            return (a.nombre || "").localeCompare(b.nombre || "");
          });

          for (const z of zonesArray) {
            const opt = document.createElement("option");
            opt.value = z.id;
            opt.textContent = `${z.nombre} (${z.nivel || "sin nivel"}) · ${z.count} reportes`;
            zoneFilterEl.appendChild(opt);
          }

          zoneFilterEl.addEventListener("change", onZoneFilterChange);
        }

        function onZoneFilterChange() {
          const selectedZoneId = zoneFilterEl.value || null;

          markers.forEach((m) => {
            const inZone =
              !selectedZoneId || m.zoneId === selectedZoneId;

            if (inZone) {
              if (!map.hasLayer(m.marker)) {
                m.marker.addTo(map);
              }
            } else {
              if (map.hasLayer(m.marker)) {
                map.removeLayer(m.marker);
              }
            }
          });

          if (!selectedZoneId) {
            setStatus("Mostrando todas las zonas.", "ok");
          } else {
            setStatus("Filtrando por zona seleccionada.", "ok");
          }
        }

        // Init
        initMap();
        loadData();
      })();
    </script>
  </body>
</html>
