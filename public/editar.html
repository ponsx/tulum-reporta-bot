<!doctype html>
<html lang="es">
  <head>
    <meta charset="utf-8" />
    <title>Editar ubicación del reporte - Tulum Reporta</title>
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <!-- Leaflet CSS -->
    <link
      rel="stylesheet"
      href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
      integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY="
      crossorigin=""
    />
    <style>
      body {
        font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI",
          sans-serif;
        margin: 0;
        padding: 0;
        display: flex;
        flex-direction: column;
        height: 100vh;
      }
      header {
        padding: 0.75rem 1rem;
        background: #0f172a;
        color: #f9fafb;
        font-size: 0.9rem;
      }
      main {
        flex: 1;
        display: flex;
        flex-direction: column;
      }
      #map {
        flex: 1;
      }
      .panel {
        padding: 0.75rem 1rem;
        border-top: 1px solid #e5e7eb;
        background: #f9fafb;
        font-size: 0.9rem;
      }
      .row {
        display: flex;
        flex-direction: column;
        gap: 0.5rem;
      }
      label {
        font-weight: 500;
        font-size: 0.85rem;
      }
      input[type="text"] {
        width: 100%;
        padding: 0.4rem 0.5rem;
        border-radius: 0.25rem;
        border: 1px solid #d1d5db;
        font-size: 0.9rem;
        background-color: #f3f4f6;
      }
      input[type="text"][readonly] {
        color: #4b5563;
      }
      button {
        margin-top: 0.5rem;
        padding: 0.5rem 0.75rem;
        border-radius: 0.375rem;
        border: none;
        background: #16a34a;
        color: white;
        font-weight: 500;
        cursor: pointer;
        font-size: 0.9rem;
      }
      button:disabled {
        background: #9ca3af;
        cursor: not-allowed;
      }
      .status {
        margin-top: 0.25rem;
        font-size: 0.8rem;
      }
      .status.error {
        color: #b91c1c;
      }
      .status.ok {
        color: #15803d;
      }
    </style>
  </head>
  <body>
    <header>Tulum Reporta · Editar ubicación del reporte</header>
    <main>
      <div id="map"></div>
      <div class="panel">
        <div class="row">
          <label for="locationText">
            Referencia del lugar (solo lectura)
          </label>
          <input
            type="text"
            id="locationText"
            placeholder="Ej. Frente a la tienda X, esquina con Y..."
            readonly
          />
          <button id="saveBtn" disabled>Guardar nueva ubicación</button>
          <div id="status" class="status"></div>
        </div>
      </div>
    </main>

    <!-- Leaflet JS -->
    <script
      src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
      integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo="
      crossorigin=""
    ></script>
    <script>
      (function () {
        const params = new URLSearchParams(window.location.search);
        const incidentId = params.get("incidentId");
        const token = params.get("t");

        const statusEl = document.getElementById("status");
        const saveBtn = document.getElementById("saveBtn");
        const locationInput = document.getElementById("locationText");

        let map;
        let marker;
        let currentLatLon = null; // usamos lon, NO lng

        function setStatus(msg, type = "") {
          statusEl.textContent = msg || "";
          statusEl.className = "status" + (type ? " " + type : "");
        }

        if (!incidentId || !token) {
          setStatus(
            "Enlace inválido: falta información del reporte.",
            "error"
          );
          return;
        }

        async function loadIncident() {
          try {
            setStatus("Cargando reporte...", "");
            const res = await fetch(
              `/api/incidentes/${encodeURIComponent(
                incidentId
              )}?token=${encodeURIComponent(token)}`
            );
            if (!res.ok) {
              const err = await res.json().catch(() => ({}));
              setStatus(
                err.error || "No se pudo cargar el reporte.",
                "error"
              );
              return;
            }
            const data = await res.json();

            // OJO: el backend devuelve lat y lon, no "lng"
            const lat =
              typeof data.lat === "number" ? data.lat : 20.2119; // centro Tulum
            const lon =
              typeof data.lon === "number" ? data.lon : -87.4654;

            initMap(lat, lon);

            if (data.zona) {
              locationInput.value = data.zona;
            } else if (data.ubicacion && typeof data.ubicacion === "string") {
              locationInput.value = data.ubicacion;
            } else {
              locationInput.value = "";
            }

            setStatus(
              "Mueve el pin al lugar correcto y guarda los cambios.",
              "ok"
            );
            saveBtn.disabled = false;
          } catch (err) {
            console.error(err);
            setStatus(
              "Error cargando el reporte, intenta más tarde.",
              "error"
            );
          }
        }

        function initMap(lat, lon) {
          currentLatLon = { lat, lon };
          map = L.map("map", {
            center: [lat, lon],
            zoom: 16,
            tap: false, // mejora respuesta en mobile
          });

          L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", {
            maxZoom: 19,
          }).addTo(map);

          marker = L.marker([lat, lon], {
            draggable: true,
            autoPan: true,
            autoPanSpeed: 50,
          }).addTo(map);

          marker.on("dragstart", function () {
            map.dragging.disable();
          });

          marker.on("dragend", function () {
            const pos = marker.getLatLng();
            currentLatLon = { lat: pos.lat, lon: pos.lng };
            map.dragging.enable();
          });
        }

        saveBtn.addEventListener("click", async function () {
          if (!currentLatLon) return;
          saveBtn.disabled = true;
          setStatus("Guardando nueva ubicación...", "");

          try {
            const res = await fetch(
              `/api/incidentes/${encodeURIComponent(
                incidentId
              )}/location?token=${encodeURIComponent(token)}`,
              {
                method: "PUT",
                headers: {
                  "Content-Type": "application/json",
                },
                body: JSON.stringify({
                  lat: currentLatLon.lat,
                  lon: currentLatLon.lon, // <- aquí usamos lon, NO lng
                  // ya no mandamos location_text: se mantiene la original
                }),
              }
            );

            const data = await res.json().catch(() => ({}));

            if (!res.ok) {
              setStatus(
                data.error || "No se pudo guardar la nueva ubicación.",
                "error"
              );
              saveBtn.disabled = false;
              return;
            }

            setStatus(
              "✅ Ubicación actualizada. Gracias por ayudar a precisar el reporte.",
              "ok"
            );
          } catch (err) {
            console.error(err);
            setStatus(
              "Error guardando la ubicación, intenta más tarde.",
              "error"
            );
            saveBtn.disabled = false;
          }
        });

        loadIncident();
      })();
    </script>
  </body>
</html>
