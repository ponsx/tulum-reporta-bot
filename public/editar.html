<!doctype html>
<html lang="es">
  <head>
    <meta charset="utf-8" />
    <title>Editar ubicación del reporte - Tulum Reporta</title>
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <!-- Leaflet CSS -->
    <link
      rel="stylesheet"
      href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
      integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY="
      crossorigin=""
    />
    <style>
      body {
        font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI",
          sans-serif;
        margin: 0;
        padding: 0;
        display: flex;
        flex-direction: column;
        height: 100vh;
      }
      header {
        padding: 0.75rem 1rem;
        background: #0f172a;
        color: #f9fafb;
        font-size: 0.9rem;
      }
      main {
        flex: 1;
        display: flex;
        flex-direction: column;
      }
      #map {
        flex: 1;
      }
      .panel {
        padding: 0.75rem 1rem;
        border-top: 1px solid #e5e7eb;
        background: #f9fafb;
        font-size: 0.9rem;
      }
      button {
        width: 100%;
        margin-top: 0.5rem;
        padding: 0.5rem 0.75rem;
        border-radius: 0.375rem;
        border: none;
        background: #16a34a;
        color: white;
        font-weight: 500;
        cursor: pointer;
        font-size: 0.9rem;
      }
      button:disabled {
        background: #9ca3af;
        cursor: not-allowed;
      }
      .status {
        margin-top: 0.25rem;
        font-size: 0.8rem;
      }
      .status.error {
        color: #b91c1c;
      }
      .status.ok {
        color: #15803d;
      }
      .note {
        font-size: 0.8rem;
        color: #475569;
        margin-bottom: 0.5rem;
      }
      .preview {
        width: 100%;
        max-height: 180px;
        object-fit: cover;
        border-radius: 0.4rem;
        margin-bottom: 0.75rem;
      }
    </style>
  </head>

  <body>
    <header>Tulum Reporta · Ajustar Pin</header>

    <main>
      <div id="map"></div>

      <div class="panel">
        <div class="note">
          Ajusta el pin a la ubicación exacta del problema.  
          Tu referencia original no se mostrará por privacidad.
        </div>

        <img id="previewImg" class="preview" style="display:none" />

        <button id="saveBtn" disabled>Guardar nueva ubicación</button>

        <div id="status" class="status"></div>
      </div>
    </main>

    <!-- Leaflet JS -->
    <script
      src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
      integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo="
      crossorigin=""
    ></script>

    <script>
      (function () {
        const params = new URLSearchParams(window.location.search);
        const incidentId = params.get("incidentId");
        const token = params.get("t");

        const statusEl = document.getElementById("status");
        const saveBtn = document.getElementById("saveBtn");
        const previewImg = document.getElementById("previewImg");

        let map;
        let marker;
        let currentLatLon = null;

        function setStatus(msg, type = "") {
          statusEl.textContent = msg || "";
          statusEl.className = "status" + (type ? " " + type : "");
        }

        if (!incidentId || !token) {
          setStatus("Enlace inválido: falta información.", "error");
          return;
        }

        async function loadIncident() {
          try {
            setStatus("Cargando reporte...");

            const res = await fetch(
              `/api/incidentes/${encodeURIComponent(
                incidentId
              )}?token=${encodeURIComponent(token)}`
            );

            if (!res.ok) {
              const err = await res.json().catch(() => ({}));
              return setStatus(err.error || "Error cargando reporte.", "error");
            }

            const data = await res.json();

            const lat =
              typeof data.lat === "number" ? data.lat : 20.2119; // fallback
            const lon =
              typeof data.lon === "number" ? data.lon : -87.4654;

            if (data.foto_url) {
              previewImg.src = data.foto_url;
              previewImg.style.display = "block";
            }

            initMap(lat, lon);

            saveBtn.disabled = false;
            setStatus("Mueve el pin a la ubicación correcta.", "ok");
          } catch (err) {
            console.error(err);
            setStatus("Error cargando el reporte.", "error");
          }
        }

        function initMap(lat, lon) {
          currentLatLon = { lat, lon };

          map = L.map("map", {
            center: [lat, lon],
            zoom: 16,
            tap: true,
          });

          L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", {
            maxZoom: 19,
          }).addTo(map);

          marker = L.marker([lat, lon], { draggable: true }).addTo(map);

          marker.on("dragend", function () {
            const pos = marker.getLatLng();
            currentLatLon = { lat: pos.lat, lon: pos.lng };
          });
        }

        saveBtn.addEventListener("click", async function () {
          if (!currentLatLon) return;

          saveBtn.disabled = true;
          setStatus("Guardando nueva ubicación...");

          try {
            const res = await fetch(
              `/api/incidentes/${encodeURIComponent(
                incidentId
              )}/location?token=${encodeURIComponent(token)}`,
              {
                method: "PUT",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({
                  lat: currentLatLon.lat,
                  lon: currentLatLon.lon,
                }),
              }
            );

            const data = await res.json().catch(() => ({}));

            if (!res.ok) {
              saveBtn.disabled = false;
              return setStatus(
                data.error || "No se pudo guardar la nueva ubicación.",
                "error"
              );
            }

            setStatus(
              "✅ Ubicación actualizada correctamente.",
              "ok"
            );
          } catch (err) {
            console.error(err);
            saveBtn.disabled = false;
            setStatus("Error guardando los cambios.", "error");
          }
        });

        loadIncident();
      })();
    </script>
  </body>
</html>
