<!DOCTYPE html>
<html lang="es">
  <head>
    <meta charset="UTF-8" />
    <title>Mapa de reportes - Tulum Reporta</title>
    <meta name="viewport" content="width=device-width, initial-scale=1" />

    <!-- Leaflet CSS -->
    <link
      rel="stylesheet"
      href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
      integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY="
      crossorigin=""
    />

    <style>
      html,
      body {
        margin: 0;
        padding: 0;
        height: 100%;
        font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI",
          sans-serif;
      }

      #map {
        width: 100%;
        height: 100vh;
      }

      /* Barra de filtros flotante */
      #toolbar {
        position: fixed;
        bottom: 10px;
        left: 50%;
        transform: translateX(-50%);
        z-index: 1000;
        background: rgba(255, 255, 255, 0.96);
        border-radius: 999px;
        padding: 6px 14px;
        box-shadow: 0 2px 8px rgba(15, 23, 42, 0.18);
        font-size: 13px;
        display: flex;
        align-items: center;
        gap: 10px;
        border: 1px solid #e2e8f0;
        flex-wrap: wrap;
      }

      #toolbar label {
        font-weight: 500;
        color: #0f172a;
      }

      #zonaFilter,
      #categoriaFilter,
      #timeFilter {
        border-radius: 999px;
        border: 1px solid #cbd5f5;
        padding: 4px 10px;
        font-size: 13px;
        background: #f8fafc;
        outline: none;
      }

      .leaflet-popup-content {
        font-size: 14px;
      }
      .leaflet-popup-content-wrapper{
        margin-top:40px;
      }

      .popup-titulo {
        font-weight: 700;
        font-size: 15px;
        margin-bottom: 4px;
      }

      .popup-sub {
        color: #475569;
        font-size: 13px;
        margin-bottom: 6px;
      }

      .popup-detalle small {
        color: #666;
      }

      .popup-foto {
          margin-top: 6px;
          text-align: center;
        }
        
        .popup-foto img {
          display: block;
          max-width: 100%;
          width: 100%;          /* ocupa el ancho disponible del popup */
          height: auto;
          max-height: 200px;    /* ajusta a tu gusto */
          border-radius: 8px;
          object-fit: cover;
          margin: 0 auto 6px;
        }

      /* Ancho fijo para TODOS los popups */
        .leaflet-popup-content {
          width: 240px !important;    /* elige tu ancho ideal */
          max-width: 240px !important;
        }
        
        /* Evita que el texto rompa el dise√±o */
        .leaflet-popup-content p,
        .leaflet-popup-content div {
          word-wrap: break-word;
        }


      /* MARKERS POR CATEGOR√çA */
      .custom-marker-wrapper {
        transform: translate(-50%, -50%);
      }

      .marker-circle {
        width: 30px;
        height: 30px;
        border-radius: 999px;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 18px;
        font-weight: 700;
        border: 2px solid rgba(255, 255, 255, 1) !important;
        box-shadow: 0 1px 3px rgba(0, 0, 0, 0.25);
      }

      .marker-calles { background-color: #FFC7C4; }
      .marker-luces { background-color: #FFFFFF; }
      .marker-limpieza { background-color: #CFFFD1; }
      .marker-agua { background-color: #c8fffe; }
      .marker-espacio { background-color: #D6E7FB; }
      .marker-fauna { background-color: #E6C9A8; }
      .marker-construccion { background-color: #FFEFB3; }
      .marker-otro { background-color: #E2E2E5; }

   /* LIGHTBOX */
   .lightbox {
      position: fixed;
      inset: 0;
      background: rgba(15, 23, 42, 0.85);
      display: none;
      align-items: center;
      justify-content: center;
      z-index: 2000;
    }
    
    .lightbox.is-visible {
      display: flex;
    }
    
    #lightbox-img {
      max-width: 90vw;
      max-height: 90vh;
      border-radius: 12px;
      box-shadow: 0 10px 40px rgba(0, 0, 0, 0.6);
    }
    
    /* Opcional: cursor de zoom */
    .popup-foto img.popup-img {
      cursor: zoom-in;
    }

    </style>
  </head>

<!-- Lightbox -->
<div id="lightbox" class="lightbox">
  <img id="lightbox-img" alt="Foto del reporte ampliada" />
</div>
  <body>
    <!-- Barra de filtros -->
    <div id="toolbar">
      <label for="zonaFilter">Zona:</label>
      <select id="zonaFilter">
        <option value="">Todas las zonas</option>
      </select>

      <label for="categoriaFilter">Categor√≠a:</label>
      <select id="categoriaFilter">
        <option value="">Todas las categor√≠as</option>
      </select>

      <label for="timeFilter">Tiempo:</label>
      <select id="timeFilter">
        <option value="all">Todos</option>
        <option value="24h">√öltimas 24h</option>
        <option value="week">√öltima semana</option>
        <option value="month">Este mes</option>
        <option value="year">Este a√±o</option>
      </select>
    </div>

    <div id="map"></div>

    <!-- Leaflet JS -->
    <script
      src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
      integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo="
      crossorigin=""
    ></script>

    <!-- Turf.js para point-in-polygon -->
    <script src="https://unpkg.com/@turf/turf@6/turf.min.js"></script>

    <script>
      /* =========================
         CAPAS BASE (OSM + SAT√âLITE)
         ========================= */

      const capaOSM = L.tileLayer(
        "https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png",
        {
          maxZoom: 19,
          attribution: "¬© OpenStreetMap"
        }
      );

      const capaSatelite = L.tileLayer(
        "https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}",
        {
          maxZoom: 20,
          attribution: "¬© Esri"
        }
      );

      // Crear mapa con OSM por defecto
      const map = L.map("map", {
        center: [20.214, -87.45],
        zoom: 12,
        layers: [capaOSM]
      });

      // Control de capas
      L.control.layers(
        {
          "Mapa est√°ndar": capaOSM,
          "Sat√©lite": capaSatelite
        },
        null,
        { position: "topright" }
      ).addTo(map);

      /* =========================
         SISTEMA DE MARKERS + FILTROS
         ========================= */

      const markersLayer = L.layerGroup().addTo(map);
      let allReportes = [];
      let markersById = {};
      let zonasCollection = null; // GeoJSON de zonas

      function getCategoriaKey(nombre) {
        if (!nombre) return "otro";
        if (nombre.startsWith("Calles y Carreteras")) return "calles";
        if (nombre.startsWith("Luces y Electricidad")) return "luces";
        if (nombre.startsWith("Basura y Residuos")) return "limpieza";
        if (nombre.startsWith("Agua y Drenaje")) return "agua";
        if (nombre.startsWith("Banquetas y Parques")) return "espacio";
        if (nombre.startsWith("Animales y Fauna")) return "fauna";
        if (nombre.startsWith("Construcci√≥n y Obras")) return "construccion";
        return "otro";
      }

      function getCategoriaEmoji(nombre) {
        if (!nombre) return "üìç";
        if (nombre.startsWith("Calles y Carreteras")) return "üöó";
        if (nombre.startsWith("Luces y Electricidad")) return "üí°";
        if (nombre.startsWith("Basura y Residuos")) return "‚ôªÔ∏è";
        if (nombre.startsWith("Agua y Drenaje")) return "üíß";
        if (nombre.startsWith("Banquetas y Parques")) return "üö∂üèΩ";
        if (nombre.startsWith("Animales y Fauna")) return "üêæ";
        if (nombre.startsWith("Construcci√≥n y Obras")) return "üöß";
        return "üìç";
      }

      function createCategoriaIcon(cat) {
        return L.divIcon({
          className: "custom-marker-wrapper",
          html: `<div class="marker-circle marker-${getCategoriaKey(cat)}">${getCategoriaEmoji(cat)}</div>`,
          iconSize: [30, 30],
          iconAnchor: [15, 15],
          popupAnchor: [0, -15],
        });
      }

      function createPopupContent(inc) {
        const zonaTxt = inc.zonaNombre
          ? `<div class="popup-detalle"><small>Zona: ${inc.zonaNombre}</small></div>`
          : "";
        return `
          <div>
            <div class="popup-titulo">${inc.categoria || ""}</div>
            <div class="popup-sub">${inc.subcategoria || ""}</div>

           ${
              inc.foto_url
                ? `<div class="popup-foto">
                    <img
                      src="${inc.foto_url}"
                      alt="Foto del reporte"
                      class="popup-img"
                      data-full="${inc.foto_url}"
                    />
                  </div>`
                : ""
            }


            ${
              inc.descripcion
                ? `<div class="popup-detalle">${inc.descripcion}</div>`
                : ""
            }

            ${
              inc.gravedad
                ? `<div class="popup-detalle"><small>Peligro percibido: ${inc.gravedad}/5</small></div>`
                : ""
            }

            ${zonaTxt}
          </div>
        `;
      }

      function populateCategoriaFilter(reportes) {
        const select = document.getElementById("categoriaFilter");
        const categorias = Array.from(
          new Set(
            reportes
              .map((r) => r.categoria)
              .filter((c) => typeof c === "string" && c.trim() !== "")
          )
        ).sort((a, b) => a.localeCompare(b, "es"));

        categorias.forEach((cat) => {
          const opt = document.createElement("option");
          opt.value = cat;
          opt.textContent = cat;
          select.appendChild(opt);
        });
      }

      function populateZonaFilter(reportes) {
        const select = document.getElementById("zonaFilter");
        // limpiar opciones (dejando "Todas")
        while (select.options.length > 1) {
          select.remove(1);
        }

        const zonas = Array.from(
          new Set(
            reportes
              .map((r) => r.zonaNombre)
              .filter((z) => typeof z === "string" && z.trim() !== "")
          )
        ).sort((a, b) => a.localeCompare(b, "es"));

        zonas.forEach((zona) => {
          const opt = document.createElement("option");
          opt.value = zona;
          opt.textContent = zona;
          select.appendChild(opt);
        });
      }

      // ---- Filtro temporal ----
      function pasaFiltroTiempo(inc, filtroTiempo) {
        if (!filtroTiempo || filtroTiempo === "all") return true;
        if (!inc.created_at) return true; // si no hay fecha, no lo escondemos

        const ahora = new Date();
        const creado = new Date(inc.created_at);
        if (isNaN(creado.getTime())) return true;

        const diffMs = ahora - creado;
        const unDiaMs = 24 * 60 * 60 * 1000;
        const unaSemanaMs = 7 * unDiaMs;

        const yearNow = ahora.getFullYear();
        const monthNow = ahora.getMonth(); // 0‚Äì11
        const yearCreated = creado.getFullYear();
        const monthCreated = creado.getMonth();

        switch (filtroTiempo) {
          case "24h":
            return diffMs <= unDiaMs;
          case "week":
            return diffMs <= unaSemanaMs;
          case "month":
            return yearCreated === yearNow && monthCreated === monthNow;
          case "year":
            return yearCreated === yearNow;
          default:
            return true;
        }
      }


      // ====== LIGHTBOX PARA FOTOS DEL POPUP ======
        const lightboxEl = document.getElementById("lightbox");
        const lightboxImg = document.getElementById("lightbox-img");
        
        function abrirLightbox(src) {
          if (!src) return;
          lightboxImg.src = src;
          lightboxEl.classList.add("is-visible");
        }
        
        function cerrarLightbox() {
          lightboxEl.classList.remove("is-visible");
          lightboxImg.src = "";
        }
        
        // Click en cualquier imagen dentro del popup
        document.addEventListener("click", (e) => {
          const img = e.target.closest(".popup-img");
          if (!img) return;
          e.preventDefault();
          const src = img.dataset.full || img.src;
          abrirLightbox(src);
        });
        
        // Cerrar al clickar en el fondo
        lightboxEl.addEventListener("click", cerrarLightbox);
        
        // Cerrar con ESC
        document.addEventListener("keydown", (e) => {
          if (e.key === "Escape") {
            cerrarLightbox();
          }
        });


      /* =========================
         GEOMETR√çA CON TURF.JS
         ========================= */

     // Asignar zona (en realidad: LOCALIDAD) a cada reporte seg√∫n lat/lon
function asignarZonaAReportes(reportes, zonasGeoJSON) {
  if (!zonasGeoJSON || !zonasGeoJSON.features) return;

  // Nos quedamos SOLO con las LOCALIDADES
  const features = zonasGeoJSON.features.filter((f) => {
    return (
      f.properties &&
      typeof f.properties.nivel === "string" &&
      f.properties.nivel.toLowerCase() === "localidad"
    );
  });

  reportes.forEach((inc) => {
    if (inc.lat == null || inc.lon == null) return;

    const lon = Number(inc.lon);
    const lat = Number(inc.lat);
    if (Number.isNaN(lon) || Number.isNaN(lat)) return;

    const punto = turf.point([lon, lat]);

    let zonaNombre = null;
    let zonaId = null;

    for (let i = 0; i < features.length; i++) {
      const f = features[i];
      if (!f.geometry) continue;

      if (turf.booleanPointInPolygon(punto, f)) {
        const props = f.properties || {};
        zonaNombre = props.nombre || props.name || `Zona ${i + 1}`;
        zonaId = props.id || props.codigo || `zona_${i + 1}`;
        break; // primera localidad que contenga el punto
      }
    }

    if (zonaNombre) {
      inc.zonaNombre = zonaNombre;
      inc.zonaId = zonaId;
    }
  });
}


      function renderMarkers() {
        markersLayer.clearLayers();
        markersById = {};

        const categoria = document.getElementById("categoriaFilter").value;
        const filtroTiempo = document.getElementById("timeFilter").value;
        const zonaSeleccionada = document.getElementById("zonaFilter").value;
        const bounds = [];

        allReportes.forEach((inc) => {
          if (!inc.lat || !inc.lon) return;

          // filtro zona
          if (zonaSeleccionada && inc.zonaNombre !== zonaSeleccionada) {
            return;
          }

          // filtro categor√≠a
          if (categoria && inc.categoria !== categoria) return;

          // filtro temporal
          if (!pasaFiltroTiempo(inc, filtroTiempo)) return;

          const marker = L.marker([inc.lat, inc.lon], {
            icon: createCategoriaIcon(inc.categoria),
          }).addTo(markersLayer);
          
          const popupHtml = createPopupContent(inc);
          marker.bindPopup(popupHtml);
          
          // Cuando se abre el popup, si la imagen carga despu√©s, reajustamos
          marker.on("popupopen", (e) => {
            const popup = e.popup;
            const popupEl = popup.getElement();
            if (!popupEl) return;
          
            const imgs = popupEl.querySelectorAll("img.popup-img");
            imgs.forEach((img) => {
              if (img.complete) {
                popup.update();
              } else {
                img.addEventListener(
                  "load",
                  () => {
                    popup.update();
                  },
                  { once: true }
                );
              }
            });
          });

          markersById[inc.id] = marker;
          bounds.push([inc.lat, inc.lon]);
        });

        if (bounds.length) {
          map.fitBounds(bounds, { padding: [40, 40] });
        }
      }

      /* =========================
         CARGA DE ZONAS + REPORTES
         ========================= */

      // 1) Cargar GeoJSON de zonas (solo para l√≥gica, no se dibuja)
      fetch("/data/zonas_tulum_ejemplo.geojson") // ajusta la ruta/nombre si usas otro archivo
        .then((res) => {
          if (!res.ok) throw new Error("No se pudo cargar el GeoJSON de zonas");
          return res.json();
        })
        .then((zonas) => {
          zonasCollection = zonas;
        })
        .catch((err) => {
          console.warn("No se pudieron cargar zonas:", err);
        })
        .finally(() => {
          // 2) Cargar reportes
          fetch("/api/reportes")
            .then((res) => res.json())
            .then((reportes) => {
              allReportes = reportes || [];

              // Si hay zonas cargadas, asignarlas a cada reporte
              if (zonasCollection) {
                asignarZonaAReportes(allReportes, zonasCollection);
                populateZonaFilter(allReportes);
              }

              populateCategoriaFilter(allReportes);
              renderMarkers();
            })
            .catch((err) => console.error("Error cargando reportes:", err));
        });

      // Eventos de filtros
      document
        .getElementById("categoriaFilter")
        .addEventListener("change", renderMarkers);

      document
        .getElementById("timeFilter")
        .addEventListener("change", renderMarkers);

      document
        .getElementById("zonaFilter")
        .addEventListener("change", renderMarkers);
    </script>
  </body>
</html>
