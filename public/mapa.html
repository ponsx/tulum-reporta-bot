<!DOCTYPE html>
<html lang="es">
  <head>
    <meta charset="UTF-8" />
    <title>Mapa de reportes - Tulum Reporta</title>
    <meta name="viewport" content="width=device-width, initial-scale=1" />

    <!-- Leaflet CSS -->
    <link
      rel="stylesheet"
      href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
      integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY="
      crossorigin=""
    />

    <style>
  html,
  body {
    margin: 0;
    padding: 0;
    height: 100%;
    font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI",
      sans-serif;
  }

  #map {
    width: 100%;
    height: 100vh;
  }

  .leaflet-popup-content {
    font-size: 14px;
  }

  .popup-titulo {
    font-weight: 700;
    font-size: 15px;
    margin-bottom: 4px;
  }

  .popup-sub {
    color: #475569;
    font-size: 13px;
    margin-bottom: 6px;
  }

  .popup-detalle {
    margin: 4px 0;
  }

  .popup-detalle small {
    color: #666;
  }

  .popup-foto {
    margin-top: 6px;
    text-align: center;
  }

  .popup-foto img {
    max-width: 240px;
    max-height: 180px;
    border-radius: 8px;
    display: block;
    margin: 0 auto 6px;
    object-fit: cover;
  }

  /* ==========
     MARKERS POR CATEGORÃA
     ========== */
  .custom-marker-wrapper {
    transform: translate(-50%, -50%);
  }

  .marker-circle {
  width: 30px;
  height: 30px;
  border-radius: 999px;
  display: flex;
  align-items: center;
  justify-content: center;
  font-size: 18px;
  font-weight: 700;
  color: inherit; /* â† emoji tal cual viene */
  border: 2px solid #ffffff;
}



/* Calles y Carreteras ğŸš— â€“ emoji rojo â†’ fondo turquesa complementario */
.marker-calles {
  background-color: #00CFCF;
}

/* Luces y Electricidad ğŸ’¡ â€“ emoji amarillo â†’ fondo azul intenso complementario */
.marker-luces {
  background-color: #0050FF;
}

/* Basura y Residuos â™»ï¸ â€“ emoji verde â†’ fondo magenta complementario */
.marker-limpieza {
  background-color: #D633FF;
}

/* Agua y Drenaje ğŸ’§ â€“ emoji azul â†’ fondo naranja complementario */
.marker-agua {
  background-color: #FF7A33;
}

/* Banquetas y Parques ğŸš¶ğŸ½ â€“ emoji azul/blanco â†’ fondo coral rojizo complementario */
.marker-espacio {
  background-color: #FF6F5E;
}

/* Animales y Fauna ğŸ¾ â€“ emoji marrÃ³n â†’ fondo azul cielo complementario */
.marker-fauna {
  background-color: #4DAAFF;
}

/* ConstrucciÃ³n y Obras ğŸš§ â€“ emoji amarillo/negro â†’ fondo azul ultramar complementario */
.marker-construccion {
  background-color: #2F3CFF;
}

/* Otro tipo de problema â“ â€“ emoji gris/rojo â†’ fondo cyan elÃ©ctrico complementario */
.marker-otro {
  background-color: #00D8FF;
}

</style>

  </head>

  <body>
    <div id="map"></div>

    <!-- Leaflet JS -->
    <script
      src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
      integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo="
      crossorigin=""
    ></script>

    <script>
  // Vista inicial en Tulum
  const map = L.map("map").setView([20.214, -87.45], 12);

  // Capa base OSM
  L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", {
    maxZoom: 19,
    attribution:
      '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors',
  }).addTo(map);

  // ==== Helpers para markers por categorÃ­a ====

  function getCategoriaKey(nombre) {
    if (!nombre) return "otro";

    if (nombre.startsWith("Calles y Carreteras")) return "calles";
    if (nombre.startsWith("Luces y Electricidad")) return "luces";
    if (nombre.startsWith("Limpieza y Basura")) return "limpieza";
    if (nombre.startsWith("Agua y Drenaje")) return "agua";
    if (nombre.startsWith("Banquetas y Parques")) return "espacio";
    if (nombre.startsWith("Animales y Fauna")) return "fauna";
    if (nombre.startsWith("ConstrucciÃ³n y Obras")) return "construccion";

    return "otro";
  }

  function getCategoriaEmoji(nombre) {
    if (!nombre) return "ğŸ“";

    if (nombre.startsWith("Calles y Carreteras")) return "ğŸš—";
    if (nombre.startsWith("Luces y Electricidad")) return "ğŸ’¡";
    if (nombre.startsWith("Limpieza y Basura")) return "â™»ï¸";
    if (nombre.startsWith("Agua y Drenaje")) return "ğŸ’§";
    if (nombre.startsWith("Banquetas y Parques")) return "ğŸš¶ğŸ½";
    if (nombre.startsWith("Animales y Fauna")) return "ğŸ¾";
    if (nombre.startsWith("ConstrucciÃ³n y Obras")) return "ğŸš§";

    return "ğŸ“";
  }

  function createCategoriaIcon(categoria) {
    const key = getCategoriaKey(categoria);
    const emoji = getCategoriaEmoji(categoria);

    return L.divIcon({
      className: "custom-marker-wrapper",
      html: `<div class="marker-circle marker-${key}">${emoji}</div>`,
      iconSize: [30, 30],
      iconAnchor: [15, 15],
      popupAnchor: [0, -16],
    });
  }

  // Cargar reportes publicados
  fetch("/api/reportes")
    .then((res) => res.json())
    .then((reportes) => {
      const markers = {};
      const bounds = [];

      reportes.forEach((inc) => {
        if (!inc.lat || !inc.lon) return;

        const icon = createCategoriaIcon(inc.categoria);

        const marker = L.marker([inc.lat, inc.lon], { icon }).addTo(map);

        const popup = `
          <div>
            <div class="popup-titulo">${inc.categoria}</div>
            <div class="popup-sub">${inc.subcategoria || ""}</div>

            ${
              inc.foto_url
                ? `
                <div class="popup-foto">
                  <a href="${inc.foto_url}" target="_blank" rel="noopener noreferrer">
                    <img src="${inc.foto_url}" alt="Foto del reporte" />
                  </a>
                </div>
                `
                : ""
            }

            ${
              inc.descripcion
                ? `<div class="popup-detalle">${inc.descripcion}</div>`
                : ""
            }

            ${
              inc.gravedad
                ? `<div class="popup-detalle"><small>Peligro percibido: ${inc.gravedad}/5</small></div>`
                : ""
            }
          </div>
        `;

        marker.bindPopup(popup);
        markers[inc.id] = marker;
        bounds.push([inc.lat, inc.lon]);
      });

      // Ajustar vista a todos los marcadores
      if (bounds.length > 0) {
        map.fitBounds(bounds, { padding: [40, 40] });
      }

      // Si viene ?i= o ?id= centrar y abrir el popup
      const params = new URLSearchParams(window.location.search);
      const targetId = params.get("i") || params.get("id");

      if (targetId && markers[targetId]) {
        const m = markers[targetId];
        map.setView(m.getLatLng(), 17);
        m.openPopup();
      }
    })
    .catch((err) => console.error("Error cargando reportes:", err));
</script>

  </body>
</html>
