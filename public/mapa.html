<!DOCTYPE html>
<html lang="es">
  <head>
    <meta charset="UTF-8" />
    <title>Mapa de reportes - Tulum Reporta</title>
    <meta name="viewport" content="width=device-width, initial-scale=1" />

    <!-- Leaflet CSS -->
    <link
      rel="stylesheet"
      href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
      crossorigin=""
    />

    <!-- MarkerCluster CSS -->
    <link
      rel="stylesheet"
      href="https://unpkg.com/leaflet.markercluster@1.5.3/dist/MarkerCluster.css"
    />
    <link
      rel="stylesheet"
      href="https://unpkg.com/leaflet.markercluster@1.5.3/dist/MarkerCluster.Default.css"
    />

    <!-- Font Awesome para íconos de marcadores -->
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css"
    />

    <style>
      :root {
        --ui-gap: 16px; /* margen base HUD (botón + filtros) */
      }

      html,
      body {
        margin: 0;
        padding: 0;
        height: 100%;
        font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI",
          sans-serif;
      }

      #map {
        width: 100%;
        height: 100vh;
      }

      /* ==== Toolbar de filtros (popup) ==== */
      #toolbar {
        position: fixed;
        bottom: calc(var(--ui-gap) * 3.5); /* queda encima del botón */
        left: 50%;
        transform: translateX(-50%) translateY(20px);
        z-index: 1100;

        max-width: calc(100% - (var(--ui-gap) * 2));

        background: rgba(255, 255, 255, 0.96);
        border-radius: 999px;
        padding: 6px 14px;
        box-shadow: 0 2px 8px rgba(15, 23, 42, 0.18);
        font-size: 13px;
        display: flex;
        align-items: center;
        gap: 10px;
        border: 1px solid #e2e8f0;
        flex-wrap: wrap;

        opacity: 0;
        pointer-events: none;
        transition: opacity 0.25s ease, transform 0.25s ease;
      }

      #toolbar.is-visible {
        opacity: 1;
        pointer-events: auto;
        transform: translateX(-50%) translateY(0);
      }

      #toolbar label {
        font-weight: 500;
        color: #0f172a;
      }

      #zonaFilter,
      #categoriaFilter,
      #timeFilter {
        border-radius: 999px;
        border: 1px solid #cbd5f5;
        padding: 4px 10px;
        font-size: 13px;
        background: #f8fafc;
        outline: none;
      }

      /* ==== Botón flotante Filtros ==== */
      .toggle-filters-btn {
        position: fixed;
        bottom: var(--ui-gap);
        left: var(--ui-gap);
        z-index: 1200;
        background: #0f172a;
        color: white;
        padding: 10px 14px;
        border-radius: 12px;
        font-size: 14px;
        border: none;
        cursor: pointer;
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
        transition: background 0.2s ease;
      }

      .toggle-filters-btn:hover {
        background: #1e293b;
      }

      /* ==== Popups Leaflet ==== */
      .leaflet-popup-content {
        font-size: 14px;
        width: 240px !important;
        max-width: 240px !important;
      }

      .leaflet-popup-content-wrapper {
        margin-top: 40px;
      }

      .leaflet-popup-content p,
      .leaflet-popup-content div {
        word-wrap: break-word;
      }

      .popup-titulo {
        font-weight: 700;
        font-size: 15px;
        margin-bottom: 4px;
      }

      .popup-sub {
        color: #475569;
        font-size: 13px;
        margin-bottom: 6px;
      }

      .popup-detalle small {
        color: #666;
      }

      .popup-foto {
        margin-top: 6px;
        text-align: center;
      }

      .popup-foto img {
        display: block;
        max-width: 100%;
        width: 100%;
        height: auto;
        max-height: 200px;
        border-radius: 8px;
        object-fit: cover;
        margin: 0 auto 6px;
      }

      /* ==== Marcadores personalizados ==== */
      .custom-marker-wrapper {
        transform: translate(-50%, -50%);
      }

      .marker-circle {
        width: 32px;
        height: 32px;
        border-radius: 999px;
        display: flex;
        align-items: center;
        justify-content: center;
        border: 2px solid rgba(255, 255, 255, 1) !important;
        box-shadow: 0 1px 3px rgba(0, 0, 0, 0.35);

        /* Animación de entrada */
        opacity: 0;
        transform: scale(0.4);
        animation: pin-pop 0.35s ease-out forwards;
      }

      .marker-circle i {
        display: inline-block;
        font-size: 18px;
        line-height: 1;
        color: #fff;
        text-shadow: 0 0 3px rgba(0, 0, 0, 0.25);
      }

      /* Paleta viva y diferenciada */
      .marker-calles {
        background-color: #6b7280; /* gris carreteras */
      }
      .marker-luces {
        background-color: #f59e0b; /* amber luces */
      }
      .marker-limpieza {
        background-color: #22c55e; /* verde */
      }
      .marker-agua {
        background-color: #0ea5e9; /* azul cielo */
      }
      .marker-espacio {
        background-color: #a855f7; /* púrpura banquetas */
      }
      .marker-fauna {
        background-color: #14b8a6; /* turquesa fauna */
      }
      .marker-construccion {
        background-color: #ef4444; /* rojo obras */
      }
      .marker-otro {
        background-color: #9ca3af; /* gris */
      }

      /* Animación de entrada de pins */
      @keyframes pin-pop {
        0% {
          opacity: 0;
          transform: scale(0.4);
        }
        60% {
          opacity: 1;
          transform: scale(1.1);
        }
        100% {
          opacity: 1;
          transform: scale(1);
        }
      }

      /* ==== Lightbox ==== */
      .lightbox {
        position: fixed;
        inset: 0;
        background: rgba(15, 23, 42, 0.85);
        display: none;
        align-items: center;
        justify-content: center;
        z-index: 2000;
      }

      .lightbox.is-visible {
        display: flex;
      }

      #lightbox-img {
        max-width: 90vw;
        max-height: 90vh;
        border-radius: 12px;
        box-shadow: 0 10px 40px rgba(0, 0, 0, 0.6);
      }

      .popup-foto img.popup-img {
        cursor: zoom-in;
      }

      /* ==== Estilo básico de clusters ==== */
      .marker-cluster-small,
      .marker-cluster-medium,
      .marker-cluster-large {
        background-color: rgba(15, 23, 42, 0.85);
        border: 2px solid #f9fafb;
      }

      .marker-cluster div {
        background-color: rgba(248, 250, 252, 0.95);
        color: #0f172a;
        font-weight: 600;
      }

      /* ==== Mobile ==== */
      @media (max-width: 640px) {
        #map {
          height: 100dvh;
        }

        #toolbar {
          bottom: calc(var(--ui-gap) * 3.5);
          left: var(--ui-gap);
          right: var(--ui-gap);
          transform: translateY(20px);
          border-radius: 14px;
          padding: 10px 12px;
          flex-direction: column;
          align-items: stretch;
          gap: 6px;
        }

        #toolbar.is-visible {
          transform: translateY(0);
        }

        #toolbar label {
          margin-bottom: 2px;
          font-weight: 600;
        }

        #toolbar select {
          width: 100%;
          font-size: 14px;
          padding: 6px 8px;
        }
      }
    </style>
  </head>

  <body>
    <!-- Lightbox -->
    <div id="lightbox" class="lightbox">
      <img id="lightbox-img" alt="Foto del reporte ampliada" />
    </div>

    <!-- Barra de filtros (popup, inicialmente oculta) -->
    <div id="toolbar">
      <label for="zonaFilter">Zona:</label>
      <select id="zonaFilter">
        <option value="">Todas las zonas</option>
      </select>

      <label for="categoriaFilter">Categoría:</label>
      <select id="categoriaFilter">
        <option value="">Todas las categorías</option>
      </select>

      <label for="timeFilter">Tiempo:</label>
      <select id="timeFilter">
        <option value="all">Todos</option>
        <option value="24h">Últimas 24h</option>
        <option value="week">Última semana</option>
        <option value="month">Este mes</option>
        <option value="year">Este año</option>
      </select>
    </div>

    <div id="map"></div>

    <!-- Botón flotante para mostrar/ocultar filtros -->
    <button id="toggleFilters" class="toggle-filters-btn">Filtros</button>

    <!-- Leaflet JS -->
    <script
      src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
      crossorigin=""
    ></script>

    <!-- MarkerCluster JS -->
    <script src="https://unpkg.com/leaflet.markercluster@1.5.3/dist/leaflet.markercluster.js"></script>

    <!-- Turf.js para point-in-polygon -->
    <script src="https://unpkg.com/@turf/turf@6/turf.min.js"></script>

    <script>
      /* =========================
         CAPAS BASE (OSM + SATÉLITE)
         ========================= */

      const capaOSM = L.tileLayer(
        "https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png",
        {
          maxZoom: 19,
          attribution: "© OpenStreetMap",
        }
      );

      const capaSatelite = L.tileLayer(
        "https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}",
        {
          maxZoom: 20,
          attribution: "© Esri",
        }
      );

      const map = L.map("map", {
        center: [20.214, -87.45],
        zoom: 12,
        layers: [capaOSM],
      });

      L.control
        .layers(
          {
            "Mapa estándar": capaOSM,
            Satélite: capaSatelite,
          },
          null,
          { position: "topright" }
        )
        .addTo(map);

      /* =========================
         SISTEMA DE MARKERS + CLUSTER + FILTROS
         ========================= */

      // Grupo de clusters en vez de simple layerGroup
      const markersLayer = L.markerClusterGroup({
        showCoverageOnHover: false,
        maxClusterRadius: 50, // px – controla cuándo agrupa
        spiderfyOnEveryZoom: false,
      }).addTo(map);

      let allReportes = [];
      let markersById = {};
      let zonasCollection = null;

      function getCategoriaKey(nombre) {
        if (!nombre) return "otro";
        if (nombre.startsWith("Calles y Carreteras")) return "calles";
        if (nombre.startsWith("Luces y Electricidad")) return "luces";
        if (nombre.startsWith("Basura y Residuos")) return "limpieza";
        if (nombre.startsWith("Agua y Drenaje")) return "agua";
        if (nombre.startsWith("Banquetas y Parques")) return "espacio";
        if (nombre.startsWith("Animales y Fauna")) return "fauna";
        if (nombre.startsWith("Construcción y Obras")) return "construccion";
        return "otro";
      }

      function getCategoriaIconClass(nombre) {
        if (!nombre) return "fa-solid fa-location-dot";

        if (nombre.startsWith("Calles y Carreteras")) {
          return "fa-solid fa-car";
        }
        if (nombre.startsWith("Luces y Electricidad")) {
          return "fa-solid fa-lightbulb";
        }
        if (nombre.startsWith("Basura y Residuos")) {
          return "fa-solid fa-trash";
        }
        if (nombre.startsWith("Agua y Drenaje")) {
          return "fa-solid fa-droplet";
        }
        if (nombre.startsWith("Banquetas y Parques")) {
          return "fa-solid fa-person-walking";
        }
        if (nombre.startsWith("Animales y Fauna")) {
          return "fa-solid fa-paw";
        }
        if (nombre.startsWith("Construcción y Obras")) {
          return "fa-solid fa-person-digging";
        }

        return "fa-solid fa-location-dot";
      }

      function createCategoriaIcon(cat) {
        const catKey = getCategoriaKey(cat);
        const iconClass = getCategoriaIconClass(cat);

        return L.divIcon({
          className: "custom-marker-wrapper",
          html: `
            <div class="marker-circle marker-${catKey}">
              <i class="${iconClass}"></i>
            </div>
          `,
          iconSize: [32, 32],
          iconAnchor: [16, 16],
          popupAnchor: [0, -16],
        });
      }

      function createPopupContent(inc) {
        const zonaTxt = inc.zonaNombre
          ? `<div class="popup-detalle"><small>Zona: ${inc.zonaNombre}</small></div>`
          : "";
        return `
          <div>
            <div class="popup-titulo">${inc.categoria || ""}</div>
            <div class="popup-sub">${inc.subcategoria || ""}</div>

            ${
              inc.foto_url
                ? `<div class="popup-foto">
                    <img
                      src="${inc.foto_url}"
                      alt="Foto del reporte"
                      class="popup-img"
                      data-full="${inc.foto_url}"
                    />
                  </div>`
                : ""
            }

            ${
              inc.descripcion
                ? `<div class="popup-detalle">${inc.descripcion}</div>`
                : ""
            }

            ${
              inc.gravedad
                ? `<div class="popup-detalle"><small>Peligro percibido: ${
                    inc.gravedad
                  }/5</small></div>`
                : ""
            }

            ${zonaTxt}
          </div>
        `;
      }

      function populateCategoriaFilter(reportes) {
        const select = document.getElementById("categoriaFilter");
        const categorias = Array.from(
          new Set(
            reportes
              .map((r) => r.categoria)
              .filter((c) => typeof c === "string" && c.trim() !== "")
          )
        ).sort((a, b) => a.localeCompare(b, "es"));

        categorias.forEach((cat) => {
          const opt = document.createElement("option");
          opt.value = cat;
          opt.textContent = cat;
          select.appendChild(opt);
        });
      }

      function populateZonaFilter(reportes) {
        const select = document.getElementById("zonaFilter");
        while (select.options.length > 1) {
          select.remove(1);
        }

        const zonas = Array.from(
          new Set(
            reportes
              .map((r) => r.zonaNombre)
              .filter((z) => typeof z === "string" && z.trim() !== "")
          )
        ).sort((a, b) => a.localeCompare(b, "es"));

        zonas.forEach((zona) => {
          const opt = document.createElement("option");
          opt.value = zona;
          opt.textContent = zona;
          select.appendChild(opt);
        });
      }

      function pasaFiltroTiempo(inc, filtroTiempo) {
        if (!filtroTiempo || filtroTiempo === "all") return true;
        if (!inc.created_at) return true;

        const ahora = new Date();
        const creado = new Date(inc.created_at);
        if (isNaN(creado.getTime())) return true;

        const diffMs = ahora - creado;
        const unDiaMs = 24 * 60 * 60 * 1000;
        const unaSemanaMs = 7 * unDiaMs;

        const yearNow = ahora.getFullYear();
        const monthNow = ahora.getMonth();
        const yearCreated = creado.getFullYear();
        const monthCreated = creado.getMonth();

        switch (filtroTiempo) {
          case "24h":
            return diffMs <= unDiaMs;
          case "week":
            return diffMs <= unaSemanaMs;
          case "month":
            return yearCreated === yearNow && monthCreated === monthNow;
          case "year":
            return yearCreated === yearNow;
          default:
            return true;
        }
      }

      /* =========================
         LIGHTBOX
         ========================= */

      const lightboxEl = document.getElementById("lightbox");
      const lightboxImg = document.getElementById("lightbox-img");

      function abrirLightbox(src) {
        if (!src) return;
        lightboxImg.src = src;
        lightboxEl.classList.add("is-visible");
      }

      function cerrarLightbox() {
        lightboxEl.classList.remove("is-visible");
        lightboxImg.src = "";
      }

      document.addEventListener("click", (e) => {
        const img = e.target.closest(".popup-img");
        if (!img) return;
        e.preventDefault();
        const src = img.dataset.full || img.src;
        abrirLightbox(src);
      });

      lightboxEl.addEventListener("click", cerrarLightbox);

      document.addEventListener("keydown", (e) => {
        if (e.key === "Escape") {
          cerrarLightbox();
        }
      });

      /* =========================
         GEOMETRÍA CON TURF.JS
         ========================= */

      function asignarZonaAReportes(reportes, zonasGeoJSON) {
        if (!zonasGeoJSON || !zonasGeoJSON.features) return;

        const features = zonasGeoJSON.features.filter((f) => f.geometry);

        const prioridadNivel = {
          colonia: 0,
          localidad: 1,
          zona: 2,
          municipio: 3,
        };

        reportes.forEach((inc) => {
          if (inc.lat == null || inc.lon == null) return;

          const lon = Number(inc.lon);
          const lat = Number(inc.lat);
          if (Number.isNaN(lon) || Number.isNaN(lat)) return;

          const punto = turf.point([lon, lat]);

          let mejorFeature = null;
          let mejorPrioridad = Infinity;

          for (let i = 0; i < features.length; i++) {
            const f = features[i];
            if (!f.geometry) continue;

            if (!turf.booleanPointInPolygon(punto, f)) continue;

            const props = f.properties || {};
            const nivelRaw = (props.nivel || "").toString().toLowerCase();
            const prioridad = prioridadNivel[nivelRaw] ?? 99;

            if (prioridad < mejorPrioridad) {
              mejorPrioridad = prioridad;
              mejorFeature = f;
            }
          }

          if (mejorFeature) {
            const props = mejorFeature.properties || {};
            inc.zonaNombre =
              props.nombre || props.name || props.id || "Zona sin nombre";
            inc.zonaId = props.id || props.codigo || null;
            inc.zonaNivel = props.nivel || null;
          }
        });
      }

      function renderMarkers() {
        markersLayer.clearLayers();
        markersById = {};

        const categoria = document.getElementById("categoriaFilter").value;
        const filtroTiempo = document.getElementById("timeFilter").value;
        const zonaSeleccionada = document.getElementById("zonaFilter").value;
        const bounds = [];

        allReportes.forEach((inc) => {
          if (!inc.lat || !inc.lon) return;

          if (zonaSeleccionada && inc.zonaNombre !== zonaSeleccionada) {
            return;
          }

          if (categoria && inc.categoria !== categoria) return;

          if (!pasaFiltroTiempo(inc, filtroTiempo)) return;

          const marker = L.marker([inc.lat, inc.lon], {
            icon: createCategoriaIcon(inc.categoria),
          });

          const popupHtml = createPopupContent(inc);
          marker.bindPopup(popupHtml);

          marker.on("popupopen", (e) => {
            const popup = e.popup;
            const popupEl = popup.getElement();
            if (!popupEl) return;

            const imgs = popupEl.querySelectorAll("img.popup-img");
            imgs.forEach((img) => {
              if (img.complete) {
                popup.update();
              } else {
                img.addEventListener(
                  "load",
                  () => {
                    popup.update();
                  },
                  { once: true }
                );
              }
            });
          });

          markersLayer.addLayer(marker);
          markersById[inc.id] = marker;
          bounds.push([inc.lat, inc.lon]);
        });

        if (bounds.length) {
          map.fitBounds(bounds, { padding: [40, 40] });
        }
      }

      /* =========================
         CARGA DE ZONAS + REPORTES
         ========================= */

      fetch("/data/zonas_tulum.geojson")
        .then((res) => {
          if (!res.ok) throw new Error("No se pudo cargar el GeoJSON de zonas");
          return res.json();
        })
        .then((zonas) => {
          zonasCollection = zonas;
        })
        .catch((err) => {
          console.warn("No se pudieron cargar zonas:", err);
        })
        .finally(() => {
          fetch("/api/reportes")
            .then((res) => res.json())
            .then((reportes) => {
              allReportes = reportes || [];

              if (zonasCollection) {
                asignarZonaAReportes(allReportes, zonasCollection);
                populateZonaFilter(allReportes);
              }

              populateCategoriaFilter(allReportes);
              renderMarkers();
            })
            .catch((err) => console.error("Error cargando reportes:", err));
        });

      /* =========================
         EVENTOS DE FILTRO
         ========================= */

      document
        .getElementById("categoriaFilter")
        .addEventListener("change", renderMarkers);

      document
        .getElementById("zonaFilter")
        .addEventListener("change", renderMarkers);

      document
        .getElementById("timeFilter")
        .addEventListener("change", renderMarkers);

      /* =========================
         TOGGLE FILTROS
         ========================= */

      const toggleBtn = document.getElementById("toggleFilters");
      const toolbar = document.getElementById("toolbar");

      toggleBtn.addEventListener("click", () => {
        const visible = toolbar.classList.toggle("is-visible");
        toggleBtn.textContent = visible ? "Cerrar filtros" : "Filtros";
      });

      document.addEventListener("keydown", (e) => {
        if (e.key === "Escape" && toolbar.classList.contains("is-visible")) {
          toolbar.classList.remove("is-visible");
          toggleBtn.textContent = "Filtros";
        }
      });
    </script>
  </body>
</html>
