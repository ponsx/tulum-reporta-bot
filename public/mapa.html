<!DOCTYPE html>
<html lang="es">
  <head>
    <meta charset="UTF-8" />
    <title>Mapa de reportes - Tulum Reporta</title>
    <meta name="viewport" content="width=device-width, initial-scale=1" />

    <!-- Leaflet CSS -->
    <link
      rel="stylesheet"
      href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
      integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY="
      crossorigin=""
    />

    <style>
      html,
      body {
        margin: 0;
        padding: 0;
        height: 100%;
        font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI",
          sans-serif;
      }

      #map {
        width: 100%;
        height: 100vh;
      }

      /* Barra de filtros flotante */
      #toolbar {
        position: fixed;
        top: 10px;
        left: 50%;
        transform: translateX(-50%);
        z-index: 1000;
        background: rgba(255, 255, 255, 0.96);
        border-radius: 999px;
        padding: 6px 14px;
        box-shadow: 0 2px 8px rgba(15, 23, 42, 0.18);
        font-size: 13px;
        display: flex;
        align-items: center;
        gap: 8px;
        border: 1px solid #e2e8f0;
      }

      #toolbar label {
        font-weight: 500;
        color: #0f172a;
      }

      #categoriaFilter {
        border-radius: 999px;
        border: 1px solid #cbd5f5;
        padding: 4px 10px;
        font-size: 13px;
        background: #f8fafc;
        outline: none;
      }

      .leaflet-popup-content {
        font-size: 14px;
      }

      .popup-titulo {
        font-weight: 700;
        font-size: 15px;
        margin-bottom: 4px;
      }

      .popup-sub {
        color: #475569;
        font-size: 13px;
        margin-bottom: 6px;
      }

      .popup-detalle {
        margin: 4px 0;
      }

      .popup-detalle small {
        color: #666;
      }

      .popup-foto {
        margin-top: 6px;
        text-align: center;
      }

      .popup-foto img {
        max-width: 240px;
        max-height: 180px;
        border-radius: 8px;
        display: block;
        margin: 0 auto 6px;
        object-fit: cover;
      }

      /* ==========
         MARKERS POR CATEGOR√çA
         ========== */
      .custom-marker-wrapper {
        transform: translate(-50%, -50%);
      }

      .marker-circle {
        width: 30px;
        height: 30px;
        border-radius: 999px;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 18px;
        font-weight: 700;
        color: inherit; /* emoji tal cual viene */
        border: 1px solid #ffffff;
      }

      /* Calles y Carreteras üöó ‚Äì rojo aclarado */
      .marker-calles {
        background-color: #ffc7c4;
      }

      /* Luces y Electricidad üí° ‚Äì naranja luz */
      .marker-luces {
        background-color: #ffb84a;
      }

      /* Basura y Residuos ‚ôªÔ∏è ‚Äì verde aclarado */
      .marker-limpieza {
        background-color: #cfffd1;
      }

      /* Agua y Drenaje üíß ‚Äì turquesa aclarado */
      .marker-agua {
        background-color: #c8ebff;
      }

      /* Banquetas y Parques üö∂üèΩ ‚Äì azul jean aclarado */
      .marker-espacio {
        background-color: #d6e7fb;
      }

      /* Animales y Fauna üêæ ‚Äì sascab aclarado */
      .marker-fauna {
        background-color: #e6c9a8;
      }

      /* Construcci√≥n y Obras üöß ‚Äì amarillo obra aclarado */
      .marker-construccion {
        background-color: #ffefb3;
      }

      /* Otro tipo de problema ‚ùì ‚Äì gris aclarado */
      .marker-otro {
        background-color: #e2e2e5;
      }
    </style>
  </head>

  <body>
    <!-- Barra de filtros -->
    <div id="toolbar">
      <label for="categoriaFilter">Categor√≠a:</label>
      <select id="categoriaFilter">
        <option value="">Todas las categor√≠as</option>
        <!-- opciones din√°micas desde JS -->
      </select>
    </div>

    <div id="map"></div>

    <!-- Leaflet JS -->
    <script
      src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
      integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo="
      crossorigin=""
    ></script>

    <script>
      // Vista inicial en Tulum
      const map = L.map("map").setView([20.214, -87.45], 12);

      // Capa base OSM
      L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", {
        maxZoom: 19,
        attribution:
          '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors',
      }).addTo(map);

      // LayerGroup para controlar los markers (para filtros)
      const markersLayer = L.layerGroup().addTo(map);

      // Arrays/objetos globales
      let allReportes = [];
      let markersById = {};

      // ==== Helpers para markers por categor√≠a ====

      function getCategoriaKey(nombre) {
        if (!nombre) return "otro";

        if (nombre.startsWith("Calles y Carreteras")) return "calles";
        if (nombre.startsWith("Luces y Electricidad")) return "luces";
        if (nombre.startsWith("Limpieza y Basura")) return "limpieza";
        if (nombre.startsWith("Agua y Drenaje")) return "agua";
        if (nombre.startsWith("Banquetas y Parques")) return "espacio";
        if (nombre.startsWith("Animales y Fauna")) return "fauna";
        if (nombre.startsWith("Construcci√≥n y Obras")) return "construccion";

        return "otro";
      }

      function getCategoriaEmoji(nombre) {
        if (!nombre) return "üìç";

        if (nombre.startsWith("Calles y Carreteras")) return "üöó";
        if (nombre.startsWith("Luces y Electricidad")) return "üí°";
        if (nombre.startsWith("Limpieza y Basura")) return "‚ôªÔ∏è";
        if (nombre.startsWith("Agua y Drenaje")) return "üíß";
        if (nombre.startsWith("Banquetas y Parques")) return "üö∂üèΩ";
        if (nombre.startsWith("Animales y Fauna")) return "üêæ";
        if (nombre.startsWith("Construcci√≥n y Obras")) return "üöß";

        return "üìç";
      }

      function createCategoriaIcon(categoria) {
        const key = getCategoriaKey(categoria);
        const emoji = getCategoriaEmoji(categoria);

        return L.divIcon({
          className: "custom-marker-wrapper",
          html: `<div class="marker-circle marker-${key}">${emoji}</div>`,
          iconSize: [30, 30],
          iconAnchor: [15, 15],
          popupAnchor: [0, -16],
        });
      }

      function createPopupContent(inc) {
        return `
          <div>
            <div class="popup-titulo">${inc.categoria || ""}</div>
            <div class="popup-sub">${inc.subcategoria || ""}</div>

            ${
              inc.foto_url
                ? `
                <div class="popup-foto">
                  <a href="${inc.foto_url}" target="_blank" rel="noopener noreferrer">
                    <img src="${inc.foto_url}" alt="Foto del reporte" />
                  </a>
                </div>
              `
                : ""
            }

            ${
              inc.descripcion
                ? `<div class="popup-detalle">${inc.descripcion}</div>`
                : ""
            }

            ${
              inc.gravedad
                ? `<div class="popup-detalle"><small>Peligro percibido: ${
                    inc.gravedad
                  }/5</small></div>`
                : ""
            }
          </div>
        `;
      }

      // Rellena el <select> de categor√≠as en base a los datos
      function populateCategoriaFilter(reportes) {
        const select = document.getElementById("categoriaFilter");
        const categorias = Array.from(
          new Set(
            reportes
              .map((r) => r.categoria)
              .filter((c) => typeof c === "string" && c.trim() !== "")
          )
        ).sort((a, b) => a.localeCompare(b, "es"));

        categorias.forEach((cat) => {
          const opt = document.createElement("option");
          opt.value = cat;
          opt.textContent = cat;
          select.appendChild(opt);
        });
      }

      // Renderiza los markers seg√∫n el filtro actual
      function renderMarkers() {
        markersLayer.clearLayers();
        markersById = {};

        const categoriaSeleccionada =
          document.getElementById("categoriaFilter").value;
        const bounds = [];

        allReportes.forEach((inc) => {
          if (!inc.lat || !inc.lon) return;

          if (categoriaSeleccionada && inc.categoria !== categoriaSeleccionada) {
            return;
          }

          const icon = createCategoriaIcon(inc.categoria);
          const marker = L.marker([inc.lat, inc.lon], { icon }).addTo(
            markersLayer
          );
          marker.bindPopup(createPopupContent(inc));

          markersById[inc.id] = marker;
          bounds.push([inc.lat, inc.lon]);
        });

        if (bounds.length > 0) {
          map.fitBounds(bounds, { padding: [40, 40] });
        }
      }

      // Centrar en un id concreto si viene en query (?i= o ?id=)
      function focusFromQueryParam() {
        const params = new URLSearchParams(window.location.search);
        const targetId = params.get("i") || params.get("id");

        if (targetId && markersById[targetId]) {
          const m = markersById[targetId];
          map.setView(m.getLatLng(), 17);
          m.openPopup();
        }
      }

      // Cargar reportes publicados
      fetch("/api/reportes")
        .then((res) => res.json())
        .then((reportes) => {
          allReportes = reportes || [];

          populateCategoriaFilter(allReportes);
          renderMarkers();
          focusFromQueryParam();

          // Re-render al cambiar la categor√≠a
          document
            .getElementById("categoriaFilter")
            .addEventListener("change", () => {
              renderMarkers();
              // Si ten√≠as un link directo a un id, al cambiar de filtro ya no forzamos el foco
            });
        })
        .catch((err) => console.error("Error cargando reportes:", err));
    </script>
  </body>
</html>
