<!DOCTYPE html>
<html lang="es">
  <head>
    <meta charset="UTF-8" />
    <title>Mapa de reportes - Tulum Reporta</title>
    <meta name="viewport" content="width=device-width, initial-scale=1" />

    <!-- Leaflet CSS -->
    <link
      rel="stylesheet"
      href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
      integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY="
      crossorigin=""
    />

    <style>
      html,
      body {
        margin: 0;
        padding: 0;
        height: 100%;
        font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI",
          sans-serif;
      }

      #map {
        width: 100%;
        height: 100vh;
      }

      /* Barra de filtros flotante */
      #toolbar {
        position: fixed;
        top: 10px;
        left: 50%;
        transform: translateX(-50%);
        z-index: 1000;
        background: rgba(255, 255, 255, 0.96);
        border-radius: 999px;
        padding: 6px 14px;
        box-shadow: 0 2px 8px rgba(15, 23, 42, 0.18);
        font-size: 13px;
        display: flex;
        align-items: center;
        gap: 8px;
        border: 1px solid #e2e8f0;
      }

      #categoriaFilter {
        border-radius: 999px;
        border: 1px solid #cbd5f5;
        padding: 4px 10px;
        font-size: 13px;
        background: #f8fafc;
        outline: none;
      }

      .leaflet-popup-content {
        font-size: 14px;
      }

      .popup-titulo {
        font-weight: 700;
        font-size: 15px;
        margin-bottom: 4px;
      }

      .popup-sub {
        color: #475569;
        font-size: 13px;
        margin-bottom: 6px;
      }

      .popup-detalle small {
        color: #666;
      }

      .popup-foto img {
        max-width: 240px;
        max-height: 180px;
        border-radius: 8px;
        display: block;
        object-fit: cover;
        margin: 0 auto 6px;
      }

      /* MARKERS POR CATEGOR√çA */
      .custom-marker-wrapper {
        transform: translate(-50%, -50%);
      }

      .marker-circle {
        width: 30px;
        height: 30px;
        border-radius: 999px;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 18px;
        font-weight: 700;

        /* CONTRASTE MEJORADO */
        border: 2px solid rgba(255, 255, 255, 1) !important;
        box-shadow: 0 1px 3px rgba(0, 0, 0, 0.25);
      }

      .marker-calles { background-color: #FFC7C4; }
      .marker-luces { background-color: #FFB84A; }
      .marker-limpieza { background-color: #CFFFD1; }
      .marker-agua { background-color: #C8EBFF; }
      .marker-espacio { background-color: #D6E7FB; }
      .marker-fauna { background-color: #E6C9A8; }
      .marker-construccion { background-color: #FFEFB3; }
      .marker-otro { background-color: #E2E2E5; }
    </style>
  </head>

  <body>
    <!-- Barra de filtros -->
    <div id="toolbar">
      <label>Categor√≠a:</label>
      <select id="categoriaFilter">
        <option value="">Todas las categor√≠as</option>
      </select>
    </div>

    <div id="map"></div>

    <!-- Leaflet JS -->
    <script
      src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
      integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo="
      crossorigin=""
    ></script>

    <script>
      /* =========================
         CAPAS BASE (OSM + SAT√âLITE)
         ========================= */

      const capaOSM = L.tileLayer(
        "https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png",
        {
          maxZoom: 19,
          attribution: "¬© OpenStreetMap"
        }
      );

      const capaSatelite = L.tileLayer(
        "https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}",
        {
          maxZoom: 20,
          attribution: "¬© Esri"
        }
      );

      // Crear mapa con OSM por defecto
      const map = L.map("map", {
        center: [20.214, -87.45],
        zoom: 12,
        layers: [capaOSM]
      });

      // Control de capas (solo una satelital como pediste)
      L.control.layers(
        {
          "Mapa est√°ndar": capaOSM,
          "Sat√©lite": capaSatelite
        },
        null,
        { position: "topright" }
      ).addTo(map);

      /* =========================
         SISTEMA DE MARKERS + FILTROS
         ========================= */

      const markersLayer = L.layerGroup().addTo(map);
      let allReportes = [];
      let markersById = {};

      function getCategoriaKey(nombre) {
        if (!nombre) return "otro";
        if (nombre.startsWith("Calles y Carreteras")) return "calles";
        if (nombre.startsWith("Luces y Electricidad")) return "luces";
        if (nombre.startsWith("Basura y Residuos")) return "limpieza";
        if (nombre.startsWith("Agua y Drenaje")) return "agua";
        if (nombre.startsWith("Banquetas y Parques")) return "espacio";
        if (nombre.startsWith("Animales y Fauna")) return "fauna";
        if (nombre.startsWith("Construcci√≥n y Obras")) return "construccion";
        return "otro";
      }

      function getCategoriaEmoji(nombre) {
        if (!nombre) return "üìç";
        if (nombre.startsWith("Calles y Carreteras")) return "üöó";
        if (nombre.startsWith("Luces y Electricidad")) return "üí°";
        if (nombre.startsWith("Basura y Residuos")) return "‚ôªÔ∏è";
        if (nombre.startsWith("Agua y Drenaje")) return "üíß";
        if (nombre.startsWith("Banquetas y Parques")) return "üö∂üèΩ";
        if (nombre.startsWith("Animales y Fauna")) return "üêæ";
        if (nombre.startsWith("Construcci√≥n y Obras")) return "üöß";
        return "üìç";
      }

      function createCategoriaIcon(cat) {
        return L.divIcon({
          className: "custom-marker-wrapper",
          html: `<div class="marker-circle marker-${getCategoriaKey(cat)}">${getCategoriaEmoji(cat)}</div>`,
          iconSize: [30, 30],
          iconAnchor: [15, 15],
          popupAnchor: [0, -16],
        });
      }

      function createPopupContent(inc) {
        return `
          <div>
            <div class="popup-titulo">${inc.categoria || ""}</div>
            <div class="popup-sub">${inc.subcategoria || ""}</div>

            ${
              inc.foto_url
                ? `<div class="popup-foto"><a href="${inc.foto_url}" target="_blank"><img src="${inc.foto_url}" /></a></div>`
                : ""
            }

            ${
              inc.descripcion
                ? `<div class="popup-detalle">${inc.descripcion}</div>`
                : ""
            }

            ${
              inc.gravedad
                ? `<div class="popup-detalle"><small>Peligro percibido: ${inc.gravedad}/5</small></div>`
                : ""
            }
          </div>
        `;
      }

      function populateCategoriaFilter(reportes) {
        const select = document.getElementById("categoriaFilter");
        const categorias = [...new Set(reportes.map(r => r.categoria))].sort();

        categorias.forEach(cat => {
          if (!cat) return;
          const opt = document.createElement("option");
          opt.value = cat;
          opt.textContent = cat;
          select.appendChild(opt);
        });
      }

      function renderMarkers() {
        markersLayer.clearLayers();
        markersById = {};

        const categoria = document.getElementById("categoriaFilter").value;
        const bounds = [];

        allReportes.forEach(inc => {
          if (!inc.lat || !inc.lon) return;

          if (categoria && inc.categoria !== categoria) return;

          const marker = L.marker([inc.lat, inc.lon], {
            icon: createCategoriaIcon(inc.categoria)
          }).addTo(markersLayer);

          marker.bindPopup(createPopupContent(inc));
          markersById[inc.id] = marker;
          bounds.push([inc.lat, inc.lon]);
        });

        if (bounds.length) map.fitBounds(bounds, { padding: [40, 40] });
      }

      fetch("/api/reportes")
        .then(res => res.json())
        .then(reportes => {
          allReportes = reportes || [];
          populateCategoriaFilter(allReportes);
          renderMarkers();
        });

      document.getElementById("categoriaFilter").addEventListener("change", renderMarkers);
    </script>
  </body>
</html>
